<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Absolute Minimal Topic request demo</title>
    <link rel="stylesheet" href="style.css" content="text/css" />
</head>
<body>
<h1>Absolute Minimal Topic Demo.</h1>
<div id="err" class="hidden err"></div>
<div id="first">
    <h2>There's one button, you know what to do.</h2>
    <p>If prompted, you'll need to agree to receive notifications for this site. (Don't worry, you can turn them
    off later if you're tired of sending them to yourself.)</p>
</div>
<div id="">
    <p><label for="target">Test Machine machine</label><input name="target" value="http://localhost:8200"></p>
    <p><button id="sub">Subscribe</button></p>
</div>
<div id="success" class="hidden">
    <h2>Good News! You're subscription info has been sent to the server.</h2>
    <p>You can use the <tt>topic_pusher</tt> app to send subscription updates.</p>
    <p>To send a message without a topic:<br>
    <code>topic_pusher --msg "This is a message, Hi!"</code></p>
    <p>To send a message with a topic:<br>
    <code>topic_pusher --msg "This is a message with a topic" --topic "ATopic"</code></p>
    <p>While you may get many normal messages, you should only get one message per topic. This is more noticeable if
    you close the browser, send messages, then restart the browser.</p>
</div>
</body>
<script>
    'use strict';
    /* This page is VERY minimal. If you're interested in knowing exactly what's going on here,
    try looking at https://github.com/mozilla-services/WebPushDataTestPage
     */

     function notify(title, body) {
         let notif =new Notification(title,
                 {
                     body: body,
                     icon: "icon.png",
                     //tag: "collapse tag",  // This will collapse all notifications with this tag name
                 });
     }

     function show_err(msg, e) {
         let err = document.getElementById("err");
         if (msg == null) {
             err.classList.add("hidden");
             err.innerHTML = "";
             return;
         }
         if (e != null) {
             msg = msg + ":" + e.toString();
         }
         err.innerHTML = msg;
         err.classList.remove("hidden");
         console.error(msg, e);
     }

     function register() {
         return navigator.serviceWorker.getRegistration()
                 .then(function(reg){
                     if (!reg || !navigator.serviceWorker.controller) {
                         return navigator.serviceWorker.register("sw.js")
                                 .then(function () {
                                     console.log("Service worker loaded");
                                     window.location.reload();
                                 })
                                 .catch(function (err) {
                                     if (err.name == "SecurityError" || err.name == "NotSupportedError") {
                                         show_err("Could not start<br>This page requires a secure server " +
                                                 "(e.g. one that can serve https:// pages or be served " +
                                                 "from localhost)");
                                         return
                                     }
                                 });
                     } else {
                         console.debug(reg);
                     }
                 })
                 .catch( function(err) {
                    show_err("Registration failed", err)
                 });
     }

     function subscribe() {
         navigator.serviceWorker.getRegistration()
                 .then(function (swr) {
                     swr.pushManager.subscribe()
                             .then(function (sub_info) {
                                 console.debug(sub_info);
                                 document.getElementById("first").classList.add("hidden");
                                 sendSubscription(sub_info);
                             })
                             .catch(function (err) {
                                 show_err("Failed to send subscription", err)
                             })
                 })
                 .catch(function(err){ show_err("Fail to get reg", err)})
     }

     function sendSubscription(sub_info) {
         let uri = document.getElementsByName("target")[0].value;
         console.debug("Sending info ", sub_info);
         if (sub_info == null) {
             console.error("No subscription info!?")
             return
         }
         let headers = new Headers();
         headers.append('content-type', 'application/json');
         let body = JSON.stringify(sub_info.toJSON());
         let req = new Request(uri, {
             method: 'POST',
             mode: 'cors',
             headers: headers,
             body: body}
         );
         fetch(req)
                 .then(function(response){
                     if (response.status < 300) {
                         show_err(null);
                         console.debug("Success!");
                         document.getElementById("success").classList.remove("hidden");
                     }
                 })
                 .catch(function(e){
                     show_err("Could not send subscription data", e);
                 })
    }

    navigator.serviceWorker.addEventListener('message', function(event){
        console.debug('Service worker sent: ', JSON.stringify(event.data));
        if (event.data.type == 'content'){
            notify("Got message", event.data.content);
        }
    });

    register();
    document.getElementById("sub").addEventListener("click", function() {subscribe()});

</script>
</html>
